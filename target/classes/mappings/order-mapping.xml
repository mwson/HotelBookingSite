<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="OrderDAO">
	<!-- 주문 SEQ번호 생성 SQL -->
	<select id="selectMaxOseq" resultType="int">
		SELECT NVL2(MAX(oseq), MAX(oseq)+1, 1)
		FROM orders
	</select>
	
	<!-- 주문 테이블에 새로운 주문 생성 -->
	<insert id="insertOrder">
		INSERT INTO orders(oseq, id)
		VALUES(#{oseq}, #{id})
	</insert>
	
	<!-- 주문 상세테이블에 한 주문에 대해 상세 상품정보 생성 -->
	<insert id="insertOrderDetail">
		INSERT INTO order_detail(odseq, oseq, pseq, quantity)
		VALUES(order_detail_seq.NEXTVAL, #{oseq}, #{pseq}, #{quantity})
	</insert>
	
	<!-- 사용자별 주문내역 조회 -->
	<select id="listOrderById" resultType="order">
		SELECT *
		FROM order_view
		WHERE id=#{id}
			AND result LIKE '%' || #{result} || '%'
			AND oseq=#{oseq} 
	</select>
	
	<!-- 사용자별 주문번호 목록 조회 -->
	<select id="selectSeqOrdering" resultType="Integer">
		SELECT DISTINCT oseq
		FROM order_view
		WHERE id=#{id}
			AND result LIKE '%' || #{result} || '%'
		ORDER BY oseq DESC
	</select>
	
	<!-- 주문내역 총 개수 조회  -->
	<select id="countOrderList" parameterType="String" resultType="int">
		SELECT COUNT(*)
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY m.name) rn, od.odseq, o.oseq, o.id, o.indate, od.pseq, od.quantity,
		        m.name mname, m.zip_num, m.address, m.phone, p.name pname, p.price2, od.result
		    FROM orders o, order_detail od, member m, product p
		    WHERE od.oseq = o.oseq
		        AND od.pseq = p.pseq
		        AND o.id = m.id
		        AND m.name LIKE '%' || #{key} || '%')
	</select>
	
	<!-- 전체 주문내역 조회 -->
	<select id="listOrder" parameterType="String" resultType="order">
		SELECT *
		FROM order_view
		WHERE mname LIKE '%' || #{key} || '%'
		ORDER BY result, oseq DESC
	</select>
	
	<!-- 주문내역 조회, 페이징 -->
	<select id="listOrderwithPaging" parameterType="HashMap" resultType="order">
		<![CDATA[
		SELECT odseq, oseq, id, indate, pseq, quantity, mname, zip_num, address, phone, pname, price2, result
		FROM (SELECT ROW_NUMBER() OVER(ORDER BY m.name) rn, od.odseq, o.oseq, o.id, o.indate, od.pseq, od.quantity,
	            m.name mname, m.zip_num, m.address, m.phone, p.name pname, p.price2, od.result
	        FROM orders o, order_detail od, member m, product p
	        WHERE od.oseq = o.oseq
	            AND od.pseq = p.pseq
	            AND o.id = m.id
	            AND m.name LIKE '%' || #{key} || '%')
		WHERE rn <= #{criteria.pageNum} * #{criteria.rowsPerPage}
			AND rn > (#{criteria.pageNum} - 1) * #{criteria.rowsPerPage}
		ORDER BY result, oseq DESC
		]]>
	</select>
	
	<!-- 주문완료 처리 수정 -->
	<update id="updateOrderResult" parameterType="int">
		UPDATE order_detail
		SET result='2'
		WHERE odseq=#{odseq}
	</update>
</mapper>